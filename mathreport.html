<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인재원 수학 학생 리포트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ko.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* 기본 폰트 설정 */
        body { 
            font-family: 'Inter', 'Noto Sans KR', sans-serif; 
            background-color: #f0f2f5; /* 페이지 전체 배경색 */
        }

        /* [수정] 콘텐츠를 중앙 정렬하는 래퍼 (너비 540px로 증가) */
        .report-wrapper {
            max-width: 540px; /* 500px -> 540px */
            margin: 0 auto; /* 화면 중앙 정렬 */
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            background-color: #f8fafc; /* 앱 내부 배경색 */
            min-height: 100vh;
        }
        
        /* 배경 이미지 스타일 */
        #page-background {
            background-image: url('https://bigshol.github.io/report-generator/background2.png');
            background-position: top center;
            background-repeat: no-repeat;
            background-size: 100% auto;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 400px; /* 배경 이미지 높이 고정 */
            z-index: 0;
            opacity: 0.9;
        }

        /* 콘텐츠가 배경 위에 오도록 z-index 설정 */
        #input-section, #report-view {
            position: relative;
            z-index: 1;
        }
        
        .flatpickr-calendar { font-family: 'Noto Sans KR', sans-serif; }
        
        /* [수정] 인쇄 스타일 */
        @media print {
            body { 
                background-color: #ffffff !important;
                background-image: none !important;
                /* 브라우저가 배경 그래픽을 인쇄하도록 강제 (일부 브라우저만 지원) */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .report-wrapper {
                max-width: 100% !important;
                margin: 0 !important;
                box-shadow: none !important;
                min-height: auto !important;
            }
            /* 인쇄 시 강제로 static 레이아웃으로 변경 */
            body, .report-wrapper, #page-background, #input-section, #report-view, #report-header {
                position: static !important;
                z-index: auto !important;
                padding-top: 0 !important; 
                margin-top: 0 !important;
            }
            #report-header {
                margin-bottom: 1rem !important;
            }

            #input-section, #report-buttons { display: none !important; } 

            #report-view { 
                display: block !important; 
                box-shadow: none !important; 
                margin: 0 !important; 
                max-width: 100% !important; 
                border: none !important; 
                padding: 1rem !important; 
            }
            
            /* [수정] 배경 이미지를 인쇄 시 보이도록 시도 (브라우저 설정 필요) */
            #page-background { 
                display: block !important; 
                position: absolute !important; /* 인쇄 시에도 위치 고정 */
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                height: 400px !important;
                z-index: -1 !important; /* 내용 뒤로 보내기 */
            }
            
            /* 로고와 아이콘 인쇄 시 보이도록 수정 */
            #report-header img { display: block !important; } 
            .report-card-header .icon-wrap img { display: block !important; }

            .report-card { 
                box-shadow: none !important; 
                border: 1px solid #e5e7eb; 
                margin-bottom: 1rem !important;
                page-break-inside: avoid; 
            }
            
            /* 인쇄 시 편집 불가능하게 */
            .editable-textarea {
                display: none !important; /* 인쇄 시 textarea 숨김 */
            }
            .print-only-text {
                display: block !important; /* 인쇄 시에만 p 태그 보임 */
            }
        }
        
        /* 텍스트 영역 기본 스타일 */
        textarea { 
            resize: none; 
            overflow-y: hidden; 
        }
        .test-input-grid { 
            display: grid; 
            grid-template-columns: repeat(2, minmax(0, 1fr)); 
            gap: 1rem; 
            align-items: end; 
        }
        .test-score-display { 
            margin-top: 0.5rem; 
            font-weight: 600; 
            color: #4f46e5; 
        }
        .custom-test-name-input { 
            margin-bottom: 0.5rem; 
        }
        
        /* 새로운 리포트 카드 디자인 */
        .report-card { 
            background-color: white; 
            border-radius: 1rem; 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }
        .report-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .report-card-header .title-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex-grow: 1;
            padding-right: 1rem; /* 아이콘과의 간격 */
        }
        .report-card-header .label-en {
            font-size: 0.8rem;
            font-weight: 500;
            color: #9ca3af; 
        }
        .report-card-header .title-ko {
            font-size: 2.5rem; 
            font-weight: 900;
            color: #1f2937;
            line-height: 1.1;
        }
        .report-card-header .icon-wrap {
            width: 7rem; 
            height: 7rem;
            flex-shrink: 0;
        }
        .report-card-header .icon-wrap img {
            width: 100%;
            height: 100%;
            object-fit: contain; 
        }
        .report-card .divider {
            height: 1px;
            background-color: #f3f4f6; 
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        .report-card p, .report-card ul li { 
            font-size: 1.1rem; 
            color: #374151; 
            line-height: 1.7; 
            white-space: pre-wrap; 
            font-weight: 500;
        }
        .report-card ul { 
            list-style-type: none; 
            padding-left: 0; 
        }
        .report-card ul li { 
            position: relative; 
            padding-left: 1.5rem; 
            margin-bottom: 0.5rem; 
            font-size: 1.1rem;
            font-weight: 500;
        }
        .report-card ul li::before { 
            content: "✓"; 
            position: absolute; 
            left: 0; 
            color: #4f46e5; 
            font-weight: 900; 
            font-size: 1rem;
        }

        /* '전하는 말' 편집 가능 텍스트 영역 스타일 */
        .editable-textarea {
            width: 100%;
            border: none;
            resize: none;
            padding: 0;
            margin: 0;
            font-family: inherit;
            font-size: 1.1rem; /* p태그와 동일하게 */
            font-weight: 500; /* p태그와 동일하게 */
            line-height: 1.7; /* p태그와 동일하게 */
            color: #374151; /* p태그와 동일하게 */
            white-space: pre-wrap;
            overflow-y: hidden; 
            background-color: transparent;
            -webkit-user-select: text; 
            user-select: text;
            min-height: 100px; /* 최소 높이 설정 */
        }
        .editable-textarea:focus {
            outline: 1px solid #d1d5db; 
            box-shadow: 0 0 5px rgba(79, 70, 229, 0.1);
            border-radius: 0.25rem;
            background-color: #fafafa; 
        }
        
        /* [추가] 인쇄용 텍스트 (평소엔 숨김) */
        .print-only-text {
            display: none;
            font-size: 1.1rem; 
            color: #374151; 
            line-height: 1.7; 
            white-space: pre-wrap; 
            font-weight: 500;
        }
        
        /* 리포트 헤더 (이름, 날짜) */
        #report-header { 
            text-align: center; 
            margin-bottom: 2rem; 
            padding-top: 10rem; 
            position: relative;
        }
        #report-header img.academy-logo { 
            width: 8rem; 
            height: 8rem;
            margin: 0 auto 1rem auto; 
            border-radius: 1.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            background: white;
            padding: 0.5rem;
        } 
        #report-header h1 { 
            font-size: 4rem; 
            font-weight: 900; 
            color: #1f2937; 
            line-height: 1;
        }
        #report-header p { 
            font-size: 1.75rem; 
            font-weight: 700; 
            color: #374151; 
            margin-top: 0.5rem;
        }
        
        /* 입력 폼 스타일 */
        label .required-star { 
            color: #ef4444; 
            margin-left: 2px; 
        }
        .error-highlight { 
            border-color: #ef4444 !important; 
        }
        
        /* 입력폼 상단 헤더 */
        .form-header {
            text-align: center;
            padding: 2rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 2rem;
        }
        .form-header img {
            width: 5rem;
            height: 5rem;
            margin: 0 auto 1rem auto;
        }
        .form-header h1 {
            font-size: 2.25rem; 
            font-weight: 900;
            color: #4f46e5;
        }
        .form-header p {
            font-size: 1.1rem;
            margin-top: 0.5rem;
            color: #4b5563;
        }
        .form-section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            border-left: 5px solid #4f46e5;
            padding-left: 0.75rem;
            margin-bottom: 1.5rem;
        }
        /* 입력 필드 스타일 */
        input[type="text"], input[type="number"], select, textarea {
            font-size: 1rem;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
            outline: none;
        }
        label {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100"> 

    <!-- 전체 콘텐츠를 감싸고 중앙 정렬하는 래퍼 -->
    <div class="report-wrapper">
    
        <!-- 배경 이미지 컨테이너 -->
        <div id="page-background"></div>

        <!-- 입력 섹션 -->
        <div id="input-section" class="p-4">
            
            <div class="max-w-4xl mx-auto p-5 bg-white rounded-2xl shadow-xl space-y-6">
                
                <div class="form-header">
                    <img src="https://bigshol.github.io/report-generator/academy_logo%20(circle).png" alt="학원 로고">
                    <h1 class="text-4xl font-extrabold text-indigo-700">인재원 수학 리포트</h1>
                    <p class="mt-2 text-lg text-gray-600">학생 데이터를 기반으로 상세 리포트를 생성합니다.</p>
                </div>
                
                <div class="space-y-4 p-4 bg-gray-50 rounded-lg">
                    <h2 class="form-section-title">0. API 키 설정 (최초 1회)</h2>
                    <p class="text-base text-gray-600">AI 자동 생성을 사용하려면 Google AI Studio에서 발급받은 API 키가 필요합니다. 입력된 키는 이 브라우저에만 저장됩니다.</p>
                    <div>
                        <label for="apiKeyInput">Google AI API Key</label>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="apiKeyInput" class="w-full" placeholder="AIza...">
                            <button id="saveApiKey" class="w-full sm:w-auto bg-gray-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-700 transition duration-200">
                                키 저장
                            </button>
                        </div>
                        <p id="apiKeyStatus" class="text-sm mt-2 hidden"></p>
                    </div>
                </div>

                <hr>

                <div class="space-y-4">
                    <h2 class="form-section-title">1. 기본 정보</h2>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label for="studentName">학생 이름<span class="required-star">*</span></label>
                            <input type="text" id="studentName" placeholder="예: 김재원">
                        </div>
                        <div>
                            <label for="parentSelect">리포트 받으시는 분</label>
                            <select id="parentSelect">
                                <option value="부모님께">부모님께</option>
                                <option value="어머님께">어머님께</option>
                                <option value="아버님께">아버님께</option>
                                <option value="할머님께">할머님께</option>
                                <option value="할아버님께">할아버님께</option>
                            </select>
                        </div>
                        <div>
                            <label for="reportDate">리포트 날짜<span class="required-star">*</span></label>
                            <input type="text" id="reportDate" placeholder="날짜 선택">
                        </div>
                        <div>
                            <label for="homeworkRate">숙제 수행률 (%)</label>
                            <input type="number" id="homeworkRate" placeholder="예: 90" min="0" max="100">
                        </div>
                        <div>
                            <label for="todayProgress">오늘의 진도<span class="required-star">*</span></label>
                            <textarea id="todayProgress" class="w-full min-h-[100px]" placeholder="예: 다항식의 곱셈 개념 학습 및 유형 문제 풀이"></textarea>
                        </div>
                        <div>
                            <label for="todayHomework">오늘의 숙제<span class="required-star">*</span></label>
                            <textarea id="todayHomework" class="w-full min-h-[100px]" placeholder="예: 개념원리 p.35~38 풀기, 오답노트 정리"></textarea>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <h2 class="form-section-title">2. 수학 테스트 결과</h2>
                    
                    <div class="p-4 border rounded-lg space-y-3">
                        <p class="font-medium text-gray-700 text-lg">일일테스트 (지난 시간 복습)</p>
                        <div class="test-input-grid">
                            <div><label for="totalQ_daily" class="text-sm">총 문항</label><input type="number" id="totalQ_daily" placeholder="10"></div>
                            <div><label for="correctA_daily" class="text-sm">정답 수</label><input type="number" id="correctA_daily" placeholder="8"></div>
                        </div>
                        <p id="scoreDisplay_daily" class="test-score-display text-base"></p>
                    </div>

                    <div class="p-4 border rounded-lg space-y-3">
                        <p class="font-medium text-gray-700 text-lg">확인테스트 (오늘 수업)</p>
                        <div class="test-input-grid">
                            <div><label for="totalQ_confirm" class="text-sm">총 문항</label><input type="number" id="totalQ_confirm" placeholder="5"></div>
                            <div><label for="correctA_confirm" class="text-sm">정답 수</label><input type="number" id="correctA_confirm" placeholder="4"></div>
                        </div>
                        <p id="scoreDisplay_confirm" class="test-score-display text-base"></p>
                    </div>

                    <div class="p-4 border rounded-lg space-y-3">
                        <input type="text" id="customTestName" class="custom-test-name-input font-medium text-lg" placeholder="추가 테스트 이름 입력 (예: 단원평가)">
                        <div class="test-input-grid">
                            <div><label for="totalQ_custom" class="text-sm">총 문항</label><input type="number" id="totalQ_custom" placeholder="25"></div>
                            <div><label for="correctA_custom" class="text-sm">정답 수</label><input type="number" id="correctA_custom" placeholder="20"></div>
                        </div>
                        <p id="scoreDisplay_custom" class="test-score-display text-base"></p>
                    </div>
                </div>

                <div class="space-y-4">
                    <h2 class="form-section-title">3. 학습 태도 및 역량 (AI 코멘트용)</h2>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-4">
                        <div class="space-y-1"><label for="select-participation">수업 참여도</label><select id="select-participation"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                        <div class="space-y-1"><label for="select-engagement">수업 몰입도</label><select id="select-engagement"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                        <div class="space-y-1"><label for="select-attitude">학습 태도</label><select id="select-attitude"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                        <div class="space-y-1"><label for="select-condition">컨디션</label><select id="select-condition"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                        <div class="space-y-1"><label for="select-diligence-hw">성실함 (과제)</label><select id="select-diligence-hw"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                        <div class="space-y-1"><label for="select-diligence-att">성실함 (출결)</label><select id="select-diligence-att"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                        <div class="space-y-1"><label for="select-proactiveness">주도성 (질문/탐구)</label><select id="select-proactiveness"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                        <div class="space-y-1"><label for="select-collaboration">또래와의 협업 능력</label><select id="select-collaboration"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                        <div class="space-y-1"><label for="select-concept">개념 이해도</label><select id="select-concept"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                        <div class="space-y-1"><label for="select-problemSolving">문제 해결력</label><select id="select-problemSolving"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                        <div class="space-y-1"><label for="select-perseverance">문제 해결 끈기</label><select id="select-perseverance"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                        <div class="space-y-1"><label for="select-criticalThinking">사고력</label><select id="select-criticalThinking"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h2 class="form-section-title">4. 선생님 추가 전달사항</h2>
                    <textarea id="teacherComment" class="w-full min-h-[100px]" placeholder="AI 생성 코멘트 외에 추가로 전달할 내용이 있다면 여기에 작성해주세요."></textarea>
                </div>


                <div class="pt-6 border-t">
                    <button id="generateButton" class="w-full bg-indigo-600 text-white py-4 px-6 rounded-lg text-lg font-semibold shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200 ease-in-out flex items-center justify-center">
                        <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span id="buttonText">리포트 생성하기</span> 
                    </button>
                </div>
                
                <div id="errorMessage" class="hidden p-4 bg-red-100 text-red-700 rounded-lg"></div>

            </div>
        </div>

        <!-- 리포트 뷰 섹션 -->
        <div id="report-view" class="hidden p-4">
            <div class="max-w-2xl mx-auto" style="font-family: 'Noto Sans KR', sans-serif;">
                
                <!-- 리포트 헤더 (이름, 날짜) -->
                <div id="report-header" class="text-center mb-8 pt-4">
                    <img src="https://bigshol.github.io/report-generator/academy_logo%20(circle).png" alt="학원 로고" class="academy-logo">
                    <h1 id="report-student-name-header"></h1>
                    <p id="report-date-header"></p>
                </div>

                <!-- 수업 진도 카드 -->
                <div class="report-card">
                    <div class="report-card-header">
                        <div class="title-group">
                            <span class="label-en">Class progress</span>
                            <h3 class="title-ko">수업 진도</h3>
                        </div>
                        <div class="icon-wrap">
                            <img src="https://bigshol.github.io/report-generator/cp.png" alt="수업 진도 아이콘">
                        </div>
                    </div>
                    <div class="divider"></div>
                    <p id="report-progress-display"></p>
                </div>
                
                <!-- 숙제 수행률 카드 -->
                <div class="report-card">
                    <div class="report-card-header">
                        <div class="title-group">
                            <span class="label-en">Homework progress</span>
                            <h3 class="title-ko">숙제 수행률</h3>
                        </div>
                        <div class="icon-wrap">
                            <img src="https://bigshol.github.io/report-generator/hp.png" alt="숙제 수행률 아이콘">
                        </div>
                    </div>
                    <div class="divider"></div>
                    <p id="report-homework-rate-display"></p>
                </div>

                <!-- 오늘의 숙제 카드 -->
                <div class="report-card">
                    <div class="report-card-header">
                        <div class="title-group">
                            <span class="label-en">Today's homework</span>
                            <h3 class="title-ko">오늘의 숙제</h3>
                        </div>
                        <div class="icon-wrap">
                            <img src="https://bigshol.github.io/report-generator/thw.png" alt="오늘의 숙제 아이콘">
                        </div>
                    </div>
                    <div class="divider"></div>
                    <p id="report-homework-display"></p>
                </div>

                <!-- 오늘의 테스트 점수 카드 -->
                <div class="report-card">
                    <div class="report-card-header">
                        <div class="title-group">
                            <span class="label-en">Today's test score</span>
                            <h3 class="title-ko">오늘의 테스트 점수</h3>
                        </div>
                        <div class="icon-wrap">
                            <img src="https://bigshol.github.io/report-generator/testpoint.png" alt="테스트 점수 아이콘">
                        </div>
                    </div>
                    <div class="divider"></div>
                    <ul id="report-score-list" class="space-y-1 mb-4"></ul> 
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg shadow-inner chart-container-output" style="height: 250px;">
                        <canvas id="scoreChartOutput"></canvas>
                    </div>
                </div>

                <!-- 선생님 추가 전달사항 카드 (조건부 표시) -->
                <div id="teacher-comment-card" class="report-card hidden">
                    <div class="report-card-header">
                        <div class="title-group">
                            <span class="label-en">Teacher's comment</span>
                            <h3 class="title-ko">추가 전달사항</h3>
                        </div>
                        <div class="icon-wrap">
                            <img src="https://bigshol.github.io/report-generator/tell.png" alt="전달사항 아이콘">
                        </div>
                    </div>
                    <div class="divider"></div>
                    <p id="report-teacher-comment-display"></p>
                    <p id="report-teacher-comment-print" class="print-only-text hidden"></p>
                </div>

                <!-- '전하는 말' 편집 가능하도록 <textarea>로 변경 -->
                <div class="report-card">
                    <div class="report-card-header">
                        <div class="title-group">
                            <span class="label-en">Message</span>
                            <h3 class="title-ko">전하는 말</h3>
                        </div>
                        <div class="icon-wrap">
                            <img src="https://bigshol.github.io/report-generator/tell.png" alt="전하는 말 아이콘">
                        </div>
                    </div>
                    <div class="divider"></div>
                    <textarea id="report-comment-display" class="editable-textarea print:hidden"></textarea>
                    <p id="report-comment-print" class="print-only-text hidden"></p>
                </div>
                
                <!-- 하단 푸터 (랜덤 문구용) -->
                <div class="mt-8 pt-6 border-t border-gray-200 text-center text-gray-500 text-sm">
                    <p id="report-footer-quote">본 리포트는 인재원 수학에서 학생의 성장을 돕기 위해 정성껏 작성되었습니다.</p>
                    <p class="font-semibold mt-1">인재원 수학</p>
                </div>

                <!-- 하단 버튼 영역 -->
                <div id="report-buttons" class="mt-8 mb-4 flex flex-col gap-3 print:hidden">
                    <button id="editButton" class="w-full bg-gray-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-gray-700 transition duration-200 text-base">내용 수정하기</button>
                    <button id="printButton" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-indigo-700 transition duration-200 text-base">인쇄하기 (PDF 저장)</button>
                </div>
            </div>
        </div>

        <script>
            let globalApiKey = ""; 
            let outputChartInstance = null;
            let chartDataStore = {};
            let isInitialized = false; 
            let isGenerating = false; 

            // 랜덤 푸터 문구 배열
            const footerQuotes = [
                "노력은 결코 배신하지 않습니다. 오늘 흘린 땀이 내일의 성과가 됩니다.",
                "수학은 세상을 이해하는 언어입니다. 오늘도 한 걸음 더 나아갔습니다.",
                "어려운 문제를 만났을 때가 바로 우리가 성장하는 순간입니다.",
                "꾸준함이야말로 가장 강력한 무기입니다. 오늘의 노력을 응원합니다.",
                "작은 성공이 모여 큰 성취를 이룹니다. 오늘의 성과를 축하합니다.",
                "포기하지 않는 열정이 학생의 미래를 만듭니다. 항상 응원하겠습니다.",
                "질문하는 것을 두려워하지 마세요. 호기심이 성장의 첫걸음입니다.",
                "오늘의 복습이 내일의 실력이 됩니다. 꾸준한 노력을 격려해주세요.",
                "실수를 두려워 마세요. 모든 실수는 더 나은 답을 찾는 과정입니다.",
                "학생의 빛나는 잠재력을 믿습니다. 인재원 수학이 함께 하겠습니다."
            ];

            function calculateScore(correct, total) { if (!total || total <= 0) return 0; const score = Math.round((correct / total) * 100); return Math.max(0, Math.min(score, 100)); }
            function autoGrowTextarea(element) { if (!element) return; element.style.height = 'auto'; element.style.height = (element.scrollHeight) + 'px'; }
            function getDayOfWeek(dateStr) { try { const date = new Date(dateStr); const days = ['일', '월', '화', '수', '목', '금', '토']; const dayIndex = date.getUTCDay(); return days[dayIndex]; } catch (e) { return ''; } }
            function formatFullDateString(dateStr) { try { const date = new Date(dateStr); const year = date.getUTCFullYear(); const month = date.getUTCMonth() + 1; const day = date.getUTCDate(); const dayOfWeek = getDayOfWeek(dateStr); return `${year}년 ${month}월 ${day}일 (${dayOfWeek})`; } catch (e) { return dateStr; } }
            function updateScoreDisplay(testType) { const totalInput = document.getElementById(`totalQ_${testType}`); const correctInput = document.getElementById(`correctA_${testType}`); const displayElement = document.getElementById(`scoreDisplay_${testType}`); if(totalInput && correctInput && displayElement) { const total = parseInt(totalInput.value) || 0; const correct = parseInt(correctInput.value) || 0; totalInput.classList.remove('error-highlight'); correctInput.classList.remove('error-highlight'); if(total > 0 && correct >= 0 && correct <= total) { const score = calculateScore(correct, total); displayElement.textContent = `-> ${score}점 (${correct}/${total})`; } else if (total > 0 && (correct > total || correct < 0)) { displayElement.textContent = `-> (정답 수 확인 필요)`; correctInput.classList.add('error-highlight'); } else if (total === 0 && correct > 0) { displayElement.textContent = `-> (총 문항 수 확인 필요)`; totalInput.classList.add('error-highlight'); } else { displayElement.textContent = ""; } } }
            
            // Chart.js 폰트 기본값 설정
            Chart.defaults.font.family = "'Noto Sans KR', sans-serif";
            Chart.defaults.font.size = 12;

            function initializeApp() {
                if (isInitialized) return; 
                const inputSection = document.getElementById('input-section'); const reportView = document.getElementById('report-view'); const studentNameInput = document.getElementById('studentName'); const reportDateInput = document.getElementById('reportDate'); const parentSelect = document.getElementById('parentSelect'); const todayProgressInput = document.getElementById('todayProgress'); const todayHomeworkInput = document.getElementById('todayHomework'); const homeworkRateInput = document.getElementById('homeworkRate'); const teacherCommentInput = document.getElementById('teacherComment'); 
                const testTypes = ['daily', 'confirm', 'custom']; const testInputs = {}; testTypes.forEach(type => { testInputs[`totalQ_${type}`] = document.getElementById(`totalQ_${type}`); testInputs[`correctA_${type}`] = document.getElementById(`correctA_${type}`); testInputs[`scoreDisplay_${type}`] = document.getElementById(`scoreDisplay_${type}`); }); const customTestNameInput = document.getElementById('customTestName');
                const generateButton = document.getElementById('generateButton'); const buttonText = document.getElementById('buttonText'); const loadingSpinner = document.getElementById('loadingSpinner'); const errorMessage = document.getElementById('errorMessage'); const editButton = document.getElementById('editButton'); const printButton = document.getElementById('printButton');
                const reportStudentNameHeader = document.getElementById('report-student-name-header'); const reportDateHeader = document.getElementById('report-date-header'); const reportProgressDisplay = document.getElementById('report-progress-display'); const reportHomeworkRateDisplay = document.getElementById('report-homework-rate-display'); const reportHomeworkDisplay = document.getElementById('report-homework-display'); const reportScoreList = document.getElementById('report-score-list'); const reportTeacherCommentCard = document.getElementById('teacher-comment-card'); const reportTeacherCommentDisplay = document.getElementById('report-teacher-comment-display');
                
                // '전하는 말' 요소를 textarea로 선택
                const reportCommentDisplay = document.getElementById('report-comment-display'); 
                
                const apiKeyInput = document.getElementById('apiKeyInput'); const saveApiKey = document.getElementById('saveApiKey'); const apiKeyStatus = document.getElementById('apiKeyStatus'); const selectElements = document.querySelectorAll('select[id^="select-"]');
                
                try { flatpickr(reportDateInput, { dateFormat: "Y-m-d", defaultDate: "today", locale: "ko" }); } catch (e) { console.error("Flatpickr loading failed:", e); reportDateInput.placeholder = "YYYY-MM-DD"; }
                
                loadKeyFromStorage(apiKeyInput, apiKeyStatus); 
                
                testTypes.forEach(type => updateScoreDisplay(type));
                testTypes.forEach(type => { if (testInputs[`totalQ_${type}`] && testInputs[`correctA_${type}`]) { [testInputs[`totalQ_${type}`], testInputs[`correctA_${type}`]].forEach(input => { input.addEventListener('input', () => updateScoreDisplay(type)); }); } });
                
                // '전하는 말' textarea에도 자동 높이 조절 리스너 추가
                const textareas = [todayProgressInput, todayHomeworkInput, teacherCommentInput, reportCommentDisplay];
                textareas.forEach(textarea => { 
                    if (textarea) { 
                        textarea.addEventListener('input', () => autoGrowTextarea(textarea)); 
                        autoGrowTextarea(textarea); // 초기 로드 시 높이 조절
                    } 
                });
                
                if (generateButton) { generateButton.addEventListener('click', () => handleGenerateReport( apiKeyInput, studentNameInput, reportDateInput, parentSelect, todayProgressInput, todayHomeworkInput, homeworkRateInput, teacherCommentInput, testInputs, customTestNameInput, selectElements, errorMessage, generateButton, buttonText, loadingSpinner )); } else { console.error("generateButton not found."); }
                if (editButton) { editButton.addEventListener('click', () => showInputView( reportView, inputSection, testInputs, todayProgressInput, todayHomeworkInput, teacherCommentInput )); } else { console.error("editButton not found."); }
                
                // [수정] 인쇄 버튼 핸들러
                if (printButton) { 
                    printButton.addEventListener('click', () => { 
                        console.log("Print button clicked. Preparing for print...");

                        // [추가] 인쇄 전 textarea 내용을 p 태그로 복사
                        const commentText = document.getElementById('report-comment-display').value;
                        const printP = document.getElementById('report-comment-print');
                        if (printP) {
                            printP.textContent = commentText;
                        }
                        
                        const teacherCommentP = document.getElementById('report-teacher-comment-display');
                        const printTeacherP = document.getElementById('report-teacher-comment-print');
                        if (teacherCommentP && printTeacherP) {
                            printTeacherP.textContent = teacherCommentP.textContent;
                        }

                        try {
                            window.print(); 
                        } catch (e) {
                            console.error("window.print() failed.", e);
                            alert("인쇄 기능을 사용할 수 없습니다. 브라우저의 인쇄 메뉴(Ctrl+P)를 이용해주세요.");
                        }
                    }); 
                } else { console.error("printButton not found."); }

                if (saveApiKey) { saveApiKey.addEventListener('click', () => saveKeyToStorage(apiKeyInput, apiKeyStatus)); } else { console.error("saveApiKey button not found."); }
                if(apiKeyInput) { apiKeyInput.addEventListener('input', () => { if(apiKeyStatus) apiKeyStatus.classList.add('hidden'); }); }
                
                isInitialized = true; console.log("Initialization complete."); 
            }
            
            const chartOptions = { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        max: 100, 
                        ticks: { font: { family: "'Noto Sans KR', sans-serif", size: 12 } } 
                    }, 
                    x: { 
                        ticks: { font: { family: "'Noto Sans KR', sans-serif", size: 12 } } 
                    } 
                }, 
                plugins: { 
                    legend: { display: false }, 
                    tooltip: { 
                        enabled: true, 
                        bodyFont: { font: { family: "'Noto Sans KR', sans-serif" } }, 
                        titleFont: { font: { family: "'Noto Sans KR', sans-serif" } } 
                    } 
                } 
            };
            
            function renderOutputChartConditional(conductedTests) { 
                try {
                    const ctx = document.getElementById('scoreChartOutput').getContext('2d'); if (!ctx) { console.error("scoreChartOutput canvas not found."); return; }
                    if (outputChartInstance) { outputChartInstance.destroy(); }
                    if (conductedTests.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); outputChartInstance = null; return; }
                    const labels = conductedTests.map(test => test.name); const data = conductedTests.map(test => test.score);
                    const backgroundColors = conductedTests.map((_, index) => ['rgba(67, 56, 202, 0.7)', 'rgba(99, 102, 241, 0.7)', 'rgba(165, 180, 252, 0.7)'][index % 3]);
                    const borderColors = conductedTests.map((_, index) => ['rgba(67, 56, 202, 1)', 'rgba(99, 102, 241, 1)', 'rgba(165, 180, 252, 1)'][index % 3]);
                    chartDataStore = { labels: labels, datasets: [{ label: '점수', data: data, backgroundColor: backgroundColors, borderColor: borderColors, borderWidth: 1, borderRadius: 5 }] };
                    outputChartInstance = new Chart(ctx, { type: 'bar', data: chartDataStore, options: chartOptions });
                } catch (e) { console.error("Output chart render failed:", e); }
            }
            
            // [수정] showInputView 함수에 autoGrowTextarea(reportCommentDisplay) 추가
            function showInputView(reportView, inputSection, testInputs, todayProgressInput, todayHomeworkInput, teacherCommentInput) { 
                reportView.classList.add('hidden'); inputSection.classList.remove('hidden');
                Object.keys(testInputs).filter(key => key.startsWith('scoreDisplay')).forEach(displayKey => { const type = displayKey.split('_')[1]; updateScoreDisplay(type); });
                autoGrowTextarea(todayProgressInput); 
                autoGrowTextarea(todayHomeworkInput); 
                autoGrowTextarea(teacherCommentInput); 
                
                const reportCommentDisplay = document.getElementById('report-comment-display');
                if (reportCommentDisplay) {
                    autoGrowTextarea(reportCommentDisplay);
                }
            }
            
            function showReportView(generatedComment, teacherComment, studentName, reportDate, todayProgress, todayHomework, homeworkRate, conductedTests) { 
                const reportView = document.getElementById('report-view'); const inputSection = document.getElementById('input-section'); const reportStudentNameHeader = document.getElementById('report-student-name-header'); const reportDateHeader = document.getElementById('report-date-header'); const reportProgressDisplay = document.getElementById('report-progress-display'); const reportHomeworkRateDisplay = document.getElementById('report-homework-rate-display'); const reportHomeworkDisplay = document.getElementById('report-homework-display'); const reportScoreList = document.getElementById('report-score-list'); const reportTeacherCommentCard = document.getElementById('teacher-comment-card'); const reportTeacherCommentDisplay = document.getElementById('report-teacher-comment-display'); 
                
                const reportCommentDisplay = document.getElementById('report-comment-display'); 
                
                const scoreSection = document.getElementById('report-score-list').closest('.report-card'); 
                
                reportStudentNameHeader.textContent = studentName; 
                reportDateHeader.textContent = formatFullDateString(reportDate); 
                reportProgressDisplay.textContent = todayProgress || "(입력 없음)"; 
                reportHomeworkRateDisplay.textContent = homeworkRate !== null ? `${homeworkRate}%` : "(입력 없음)"; 
                reportHomeworkDisplay.textContent = todayHomework || "(입력 없음)";
                
                reportScoreList.innerHTML = ''; 
                if (conductedTests.length > 0) {
                    conductedTests.forEach(test => { const listItem = document.createElement('li'); listItem.textContent = `${test.name}: ${test.score}점 (${test.correct}/${test.total})`; reportScoreList.appendChild(listItem); });
                    scoreSection.style.display = 'block'; renderOutputChartConditional(conductedTests); 
                } else { scoreSection.style.display = 'none'; if (outputChartInstance) { outputChartInstance.destroy(); outputChartInstance = null; } }
                
                if (teacherComment && teacherComment.trim() !== '') { 
                    reportTeacherCommentDisplay.textContent = teacherComment; 
                    reportTeacherCommentCard.classList.remove('hidden'); 
                } else { 
                    reportTeacherCommentDisplay.textContent = ''; 
                    reportTeacherCommentCard.classList.add('hidden'); 
                }
                
                reportCommentDisplay.value = generatedComment || "(코멘트 생성 실패)"; 
                autoGrowTextarea(reportCommentDisplay); // [수정] 생성 직후 높이 자동 조절

                // 랜덤 푸터 문구 설정
                const reportFooterQuote = document.getElementById('report-footer-quote');
                if (reportFooterQuote) {
                    const randomIndex = Math.floor(Math.random() * footerQuotes.length);
                    reportFooterQuote.textContent = footerQuotes[randomIndex];
                }
                
                inputSection.classList.add('hidden'); reportView.classList.remove('hidden'); window.scrollTo(0, 0); 
            }
            
            async function handleGenerateReport( apiKeyInput, studentNameInput, reportDateInput, parentSelect, todayProgressInput, todayHomeworkInput, homeworkRateInput, teacherCommentInput, testInputs, customTestNameInput, selectElements, errorMessage, generateButton, buttonText, loadingSpinner ) {
                console.log("handleGenerateReport called"); if (isGenerating) { console.log("Generation already in progress."); return; }
                if (!globalApiKey) { showError("API 키를 먼저 '0. API 키 설정'에서 입력하고 저장해 주세요.", errorMessage); if(apiKeyInput) apiKeyInput.focus(); return; }
                
                const studentName = studentNameInput.value.trim(); 
                const reportDate = reportDateInput.value; 
                const todayProgress = todayProgressInput.value.trim(); 
                const todayHomework = todayHomeworkInput.value.trim(); 
                const homeworkRateRaw = homeworkRateInput.value.trim(); const homeworkRate = homeworkRateRaw === '' ? null : parseInt(homeworkRateRaw); 
                const teacherComment = teacherCommentInput.value.trim();
                
                studentNameInput.classList.remove('error-highlight'); reportDateInput.classList.remove('error-highlight'); todayProgressInput.classList.remove('error-highlight'); todayHomeworkInput.classList.remove('error-highlight'); if(homeworkRateInput) homeworkRateInput.classList.remove('error-highlight');
                
                if (!studentName) { showError("학생 이름을 입력해주세요.", errorMessage); studentNameInput.focus(); studentNameInput.classList.add('error-highlight'); return; }
                if (!reportDate) { showError("리포트 날짜를 입력해주세요.", errorMessage); reportDateInput.focus(); reportDateInput.classList.add('error-highlight'); return; }
                if (!todayProgress) { showError("'오늘의 진도'를 입력해주세요.", errorMessage); todayProgressInput.focus(); todayProgressInput.classList.add('error-highlight'); return; } 
                if (!todayHomework) { showError("'오늘의 숙제'를 입력해주세요.", errorMessage); todayHomeworkInput.focus(); todayHomeworkInput.classList.add('error-highlight'); return; } 
                
                const conductedTests = []; const testTypeMap = { daily: '일일테스트', confirm: '확인테스트', custom: customTestNameInput.value.trim() || '추가 테스트' };
                let hasInvalidScore = false;
                
                Object.keys(testTypeMap).forEach(type => { const totalInput = testInputs[`totalQ_${type}`]; const correctInput = testInputs[`correctA_${type}`]; if (totalInput && correctInput) { const total = parseInt(totalInput.value) || 0; const correct = parseInt(correctInput.value) || 0; totalInput.classList.remove('error-highlight'); correctInput.classList.remove('error-highlight'); if (total > 0) { if (correct < 0 || correct > total) { showError(`${testTypeMap[type]}의 정답 수는 0과 ${total} 사이여야 합니다.`, errorMessage); correctInput.focus(); correctInput.classList.add('error-highlight'); hasInvalidScore = true; return; } const score = calculateScore(correct, total); conductedTests.push({ name: testTypeMap[type], total: total, correct: correct, score: score }); } else if (correct > 0) { showError(`${testTypeMap[type]}의 총 문항 수를 1 이상 입력해주세요.`, errorMessage); totalInput.focus(); totalInput.classList.add('error-highlight'); hasInvalidScore = true; return; } } });
                
                if (hasInvalidScore) return; 
                
                if (homeworkRate !== null && (homeworkRate < 0 || homeworkRate > 100)) { showError("숙제 수행률은 0과 100 사이의 숫자여야 합니다.", errorMessage); homeworkRateInput.focus(); homeworkRateInput.classList.add('error-highlight'); return; } 
                
                setLoading(true, generateButton, buttonText, loadingSpinner, errorMessage); isGenerating = true; 
                
                let characteristics = []; selectElements.forEach(select => { if (select.value) { const label = document.querySelector(`label[for='${select.id}']`).textContent; characteristics.push({ item: label, level: select.value }); } });

                // [수정] '컨디션' 항목을 고려하도록 AI 지시문 수정
                const systemPrompt = `당신은 '인재원 수학' 학원의 전문적이고 신뢰를 주는 선생님입니다.
학생의 학습 데이터를 바탕으로 [전하는 말] 섹션에 들어갈 코멘트를 작성합니다.

**매우 중요한 작성 규칙:**
1.  **말투:** 명확하고 전문적인 어투를 사용합니다. ("~입니다.", "~했습니다.", "~하겠습니다.")
2.  **금지 표현:** 감성적인 인사치레(예: '안녕하세요', '부모님께', '감사합니다')는 **절대 금지**합니다.
3.  **내용 구성 (필수 3요소):**
    * **(1) 긍정적 피드백:** 오늘 학습 태도, 테스트 결과, 숙제 수행률 등에서 **구체적으로 잘한 점이나 발전한 점**을 찾아 반드시 1~2문장 언급합니다. (예: "오늘 확인테스트에서 서술형 문제 풀이 과정이 매우 논리적이었습니다.") (잘한 점이 없다면 생략 가능)
    * **(2) 사실 기반 진단:** 오늘의 핵심 진도 및 테스트 결과를 간결하게 전달합니다. **특히 숙제 수행률 0%나 매우 낮은 테스트 점수(예: 20점)는 명확히 지적합니다.**
    * **(3) [가장 중요] 구체적인 해결책 및 방향 제시:** 오늘 학습에서 **부족한 점(예: 숙제 수행률 0%, 낮은 테스트 점수, '개선 필요' 항목)이 명확히 발견되었다면, 절대로 문제를 지적하는 것에서 끝나서는 안 됩니다.** **반드시** "다음 시간에는..." 또는 "앞으로는..."과 같이, 이 문제를 해결하기 위한 **구체적인 1:1 보완 계획(예: 보강, 오답노트 복습, 개념 재정립)을 포함해야 합니다.** 이 부분이 학부모 신뢰의 핵심입니다.
4.  **[추가] '컨디션' 항목 고려:**
    * 만약 '컨디션'이 '보통' 또는 '개선 필요'로 입력되었다면, AI는 이를 **반드시 인지**해야 합니다.
    * 저조한 학습 결과(낮은 점수, 낮은 숙제 수행률)를 **컨디션 난조 탓으로 돌리는** 공감의 말을 1~2문장 추가합니다. (예: "다만, 오늘 컨디션이 좋지 않아 학습에 집중하기 어려웠던 것으로 보입니다.", "컨디션이 좋지 않음에도 끝까지 수업에 참여했습니다.")
    * 이 경우, 보완 계획은 **"컨디션이 좋은 날"**로 일정을 조율하는 방향으로 제시합니다. (예: "컨디션이 회복되는 대로 오늘 부족했던 부분에 대해 보강을 진행하겠습니다.")
5.  **분량:** 4~7문장 내외로 작성합니다. (컨디션 항목 추가 시 조금 더 길어질 수 있음)
6.  **호칭:** 학생 이름을 부르지 말고, "오늘은", "다음 시간에는" 등으로 바로 본론을 시작합니다.
7.  **줄바꿈:** 내용상 구분이 필요하면(예: 요약과 계획 분리) \`\\n\`을 사용하여 문단을 나누어 가독성을 높여주세요.

**작성 예시 (이 구체적인 방향성을 제시하는 말투를 따르세요):**
* (좋은 예시) "오늘 일일테스트 만점으로 지난 시간 내용을 완벽히 소화한 모습입니다. 숙제 수행률도 매우 훌륭합니다.\n\n다음 시간에는 이 기세를 몰아 교재의 고난도 문제 풀이를 시작하겠습니다."
* (나쁜 예시 - 방향성 없음) "오늘 일일테스트 결과가 20점(2/10)으로 개념 이해가 부족한 것이 확인되었습니다."
* **(가장 좋은 예시 - 숙제/점수 부진)** "오늘은 일일테스트를 통해 현재 학습 상태를 정확히 진단할 수 있었습니다. 그러나 **숙제 수행률 0%**를 기록하여 학습 준비가 전혀 이루어지지 않았으며, **일일테스트 결과 역시 20점(2/10)**으로 개념 이해가 매우 부족한 것이 확인되었습니다.\n\n다음 시간에는 **수업 후 남아서 선생님과 함께 오늘 못한 숙제를 마무리**하고, **일일테스트 오답 문항을 오답노트에 정리하며 1:1로 다시 복습**하는 시간을 갖도록 하겠습니다."
* **(가장 좋은 예시 - 컨디션 난조)** "오늘 숙제 수행률은 100%로 훌륭했으나, 확인테스트 점수가 40점으로 다소 저조했습니다. **다만, 오늘 컨디션이 좋지 않아 평소보다 집중에 어려움**을 겪는 모습이 보였습니다. 테스트 결과도 이 영향이 있었던 것으로 판단됩니다.\n\n다음 시간에는 오늘 틀렸던 문항을 다시 풀어보고, **컨디션이 좋은 날을 정해 오늘 부족했던 학습에 대해 보강**하여 학습 공백이 생기지 않도록 하겠습니다. 푹 쉬고 다음 시간에 건강한 모습으로 만나길 바랍니다."

**출력:** [전하는 말]에 들어갈 본문 텍스트만 생성합니다. (다른 섹션 내용이나 제목 제외)`;
                
                let userQuery = `다음은 ${studentName} 학생의 오늘(${reportDate}) 수학 학습 데이터입니다.\n\n`; 
                userQuery += `오늘의 진도: ${todayProgress}\n`; 
                userQuery += `오늘의 숙제: ${todayHomework}\n`; 
                userQuery += `숙제 수행률: ${homeworkRate !== null ? homeworkRate + '%' : '입력 없음'}\n\n`; 
                
                userQuery += `테스트 결과:\n`; if (conductedTests.length > 0) { conductedTests.forEach(test => { userQuery += `- ${test.name}: ${test.score}점 (${test.correct}/${test.total})\n`; }); } else { userQuery += `- 오늘 실시한 테스트가 없습니다.\n`; } userQuery += `\n`;
                
                userQuery += `학습 태도 및 역량 (참고용):\n${JSON.stringify(characteristics)}\n\n`; 
                if (teacherComment) { userQuery += `선생님 추가 전달사항 (참고용. AI 코멘트에 포함하지 마세요):\n${teacherComment}\n\n`; } 
                
                userQuery += "이 데이터를 바탕으로, 위 시스템 프롬프트의 모든 규칙과 예시를 준수하여 **[전하는말]** 섹션에 들어갈 **AI 코멘트 본문만** 작성해 주세요.";
                
                try { const generatedComment = await callGeminiAPI(systemPrompt, userQuery); showReportView( generatedComment, teacherComment, studentName, reportDate, todayProgress, todayHomework, homeworkRate, conductedTests ); } 
                catch (error) { console.error("AI Generation Failed:", error); showError("리포트 생성에 실패했습니다. " + error.message, errorMessage); } 
                finally { setLoading(false, generateButton, buttonText, loadingSpinner, errorMessage); isGenerating = false; }
            }
            
            async function callGeminiAPI(systemPrompt, userQuery) {
                if (!globalApiKey) { throw new Error("API 키가 설정되지 않았습니다."); }
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${globalApiKey}`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, generationConfig: { temperature: 0.8, topP: 0.9, topK: 40 } };
                let response; let retries = 3; let delay = 2000; 
                for (let i = 0; i < retries; i++) {
                    try {
                        console.log(`Attempt ${i + 1} to call Gemini API`); 
                        response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        console.log(`API Response Status: ${response.status}`); 
                        if (response.ok) {
                            const result = await response.json();
                            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) { return result.candidates[0].content.parts[0].text.trim(); } 
                            else if (result.candidates && result.candidates[0].finishReason === "SAFETY") { throw new Error("콘텐츠 생성 중 안전상의 이유로 중단되었습니다. 입력 내용을 확인해주세요."); } 
                            else { console.error("Unexpected API response structure:", result); throw new Error("AI로부터 유효한 응답을 받지 못했습니다. (응답 형식 오류)"); }
                        } else {
                            if (response.status === 429 || response.status >= 500) { 
                                if (i === retries - 1) throw new Error(`서버 오류 또는 요청 한도 초과 (Status: ${response.status})`);
                                console.log(`Retrying after ${delay}ms due to status ${response.status}`); 
                                await new Promise(resolve => setTimeout(resolve, delay)); delay *= 2; 
                            } else {
                                const errorBody = await response.json().catch(() => ({ error: { message: response.statusText } })); 
                                const errorMessage = errorBody.error?.message || response.statusText;
                                if (response.status === 401 || response.status === 403 || (response.status === 400 && errorMessage.includes("API key not valid"))) { throw new Error(`API 키가 유효하지 않습니다. (오류: ${errorMessage})`); }
                                if (errorMessage.includes("API has not been used") || errorMessage.includes("disabled")) { throw new Error(`API 사용 설정이 필요합니다. Google Cloud에서 'Generative Language API' 또는 'Vertex AI API'를 활성화(Enable)해주세요. (오류: ${errorMessage})`); }
                                if (response.status === 400) { console.error("API Request Payload:", payload); throw new Error(`잘못된 요청입니다 (400 Bad Request). API 요청 내용을 확인해주세요. 오류: ${errorMessage}`); }
                                throw new Error(`API 오류: ${errorMessage}`);
                            }
                        }
                    } catch (networkError) {
                        if (i === retries - 1) throw new Error(`네트워크 오류: ${networkError.message}`);
                        console.log(`Retrying after ${delay}ms due to network error: ${networkError.message}`); 
                        await new Promise(resolve => setTimeout(resolve, delay)); delay *= 2;
                    }
                }
                throw new Error("Failed to generate report after multiple retries.");
            }
            
            function setLoading(isLoading, generateButton, buttonText, loadingSpinner, errorMessage) {
                if (isLoading) { generateButton.disabled = true; buttonText.textContent = "AI가 생성 중입니다..."; loadingSpinner.classList.remove('hidden'); errorMessage.classList.add('hidden'); } 
                else { generateButton.disabled = false; buttonText.textContent = "리포트 생성하기"; loadingSpinner.classList.add('hidden'); }
            }
            
            function showError(message, errorMessage) { if (!errorMessage) return; errorMessage.textContent = message; errorMessage.classList.remove('hidden'); }
            
            function saveKeyToStorage(apiKeyInput, apiKeyStatus) {
                try {
                    const key = apiKeyInput.value.trim();
                    if (key && key.startsWith('AIza')) { 
                        localStorage.setItem('injaewonApiKey_math_v1', key); globalApiKey = key;
                        apiKeyStatus.textContent = 'API 키가 브라우저에 안전하게 저장되었습니다.'; apiKeyStatus.classList.remove('hidden', 'text-red-600'); apiKeyStatus.classList.add('text-green-600');
                        apiKeyInput.value = '**********' + key.slice(-4); 
                    } else if (key.includes('**********')) {
                         apiKeyStatus.textContent = '이미 키가 저장되어 있습니다. 변경 시 새 키를 입력하세요.'; apiKeyStatus.classList.remove('hidden', 'text-red-600'); apiKeyStatus.classList.add('text-green-600');
                    } else { apiKeyStatus.textContent = "유효하지 않은 API 키 형식입니다. 'AIza...'로 시작해야 합니다."; apiKeyStatus.classList.remove('hidden', 'text-green-600'); apiKeyStatus.classList.add('text-red-600'); }
                } catch (e) {
                    console.error("Failed to save key (localStorage error):", e);
                    apiKeyStatus.textContent = "키 저장에 실패했습니다. 브라우저의 쿠키/사이트 데이터 저장 설정을 확인해주세요."; apiKeyStatus.classList.remove('hidden', 'text-green-600'); apiKeyStatus.classList.add('text-red-600');
                }
            }
            
            function loadKeyFromStorage(apiKeyInput, apiKeyStatus) {
                try {
                    const savedKey = localStorage.getItem('injaewonApiKey_math_v1'); 
                    if (savedKey) {
                        globalApiKey = savedKey; apiKeyInput.value = '**********' + savedKey.slice(-4); 
                        apiKeyStatus.textContent = '저장된 API 키를 불러왔습니다. (새 키 입력 시 덮어씁니다)'; apiKeyStatus.classList.remove('hidden', 'text-red-600'); apiKeyStatus.classList.add('text-green-600');
                    } else { apiKeyStatus.textContent = "AI 자동 생성을 사용하려면 API 키를 입력 후 '키 저장하기'를 눌러주세요."; apiKeyStatus.classList.remove('hidden', 'text-green-600'); apiKeyStatus.classList.add('text-red-600'); }
                } catch (e) {
                    console.error("Failed to load key (localStorage error):", e);
                    apiKeyStatus.textContent = "키 로드에 실패했습니다. 브라우저의 쿠키/사이트 데이터 저장 설정을 확인해주세요."; apiKeyStatus.classList.remove('hidden', 'text-green-600'); apiKeyStatus.classList.add('text-red-600');
                }
            }
            
            // 앱 초기화 실행
            document.addEventListener('DOMContentLoaded', initializeApp);

        </script>
    </div> <!-- 래퍼 종료 -->
</body>
</html>
