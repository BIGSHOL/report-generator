<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인재원 영어 학생 리포트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ko.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        .flatpickr-calendar { font-family: 'Noto Sans KR', sans-serif; }
        @media print {
            body { background-color: #ffffff; }
            #input-section, #report-buttons, #report-header-icon { display: none !important; }
            #report-view { display: block !important; box-shadow: none !important; margin: 0 !important; max-width: 100% !important; border: none !important; padding: 1rem !important; }
            .report-card { box-shadow: none !important; border: 1px solid #e5e7eb; margin-bottom: 1rem !important;}
            .report-card h3 svg { display: none !important; }
             #report-header { margin-bottom: 1rem !important; }
        }
        textarea { resize: none; overflow-y: hidden; }
        .report-card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .report-card h3 { display: flex; align-items: center; font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 0.75rem; }
         .report-card h3 svg { width: 1.25rem; height: 1.25rem; margin-right: 0.5rem; color: #4f46e5; }
        .report-card p, .report-card ul li { font-size: 0.95rem; color: #4b5563; line-height: 1.6; white-space: pre-wrap; }
        .report-card ul { list-style-type: none; padding-left: 0; }
        .report-card ul li { position: relative; padding-left: 1.25rem; margin-bottom: 0.25rem; }
         .report-card ul li::before { content: "✓"; position: absolute; left: 0; color: #4f46e5; font-weight: bold; }
         #report-header { text-align: center; margin-bottom: 2rem; padding-top: 1rem; }
         #report-header svg { width: 2.5rem; height: 2.5rem; color: #4f46e5; margin: 0 auto 0.5rem auto; }
         #report-header h1 { font-size: 1.25rem; font-weight: 600; color: #1f2937; }
         #report-header p { font-size: 0.875rem; color: #6b7280; }
         label .required-star { color: #ef4444; margin-left: 2px; }
         .error-highlight { border-color: #ef4444 !important; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="input-section">
        <div class="max-w-4xl mx-auto p-6 md:p-8 bg-white rounded-2xl shadow-xl space-y-8">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-indigo-700">인재원 영어 학생 리포트</h1>
                <p class="mt-2 text-lg text-gray-600">학생 데이터를 기반으로 학부모님께 전달할 상세 리포트를 생성합니다.</p>
            </div>
            
            <div class="space-y-4 p-4 bg-gray-100 rounded-lg">
                <h2 class="text-xl font-semibold text-gray-800 border-l-4 border-gray-500 pl-3">0. API 키 설정 (최초 1회)</h2>
                <p class="text-sm text-gray-600">AI 자동 생성을 사용하려면 Google AI Studio에서 발급받은 API 키가 필요합니다. 입력된 키는 이 브라우저에만 저장됩니다.</p>
                <div>
                    <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-1">Google AI API Key</label>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="apiKeyInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="AIza...">
                        <button id="saveApiKey" class="w-full sm:w-auto bg-gray-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-700 transition duration-200">
                            키 저장하기
                        </button>
                    </div>
                    <p id="apiKeyStatus" class="text-sm mt-2 hidden"></p>
                </div>
            </div>

            <hr>

            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-800 border-l-4 border-indigo-500 pl-3">1. 기본 정보</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">학생 이름<span class="required-star">*</span></label>
                        <input type="text" id="studentName" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="예: 김소선">
                    </div>
                    <div>
                        <label for="parentSelect" class="block text-sm font-medium text-gray-700 mb-1">리포트 받으시는 분</label>
                        <select id="parentSelect" class="w-full p-3 border border-gray-300 rounded-lg bg-white shadow-sm">
                            <option value="부모님께">부모님께</option> <option value="어머님께">어머님께</option> <option value="아버님께">아버님께</option> <option value="할머님께">할머님께</option> <option value="할아버님께">할아버님께</option>
                        </select>
                    </div>
                    <div>
                        <label for="reportDate" class="block text-sm font-medium text-gray-700 mb-1">리포트 날짜<span class="required-star">*</span></label>
                        <input type="text" id="reportDate" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="날짜 선택">
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-800 border-l-4 border-indigo-500 pl-3">2. 영어 테스트 점수 (100점 만점)</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label for="scoreListening" class="block text-sm font-medium text-gray-700 mb-1">듣기 (L/C)</label>
                        <input type="number" id="scoreListening" min="0" max="100" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="85">
                    </div>
                    <div>
                        <label for="scoreReading" class="block text-sm font-medium text-gray-700 mb-1">독해 (R/C)</label>
                        <input type="number" id="scoreReading" min="0" max="100" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="90">
                    </div>
                    <div>
                        <label for="scoreGrammar" class="block text-sm font-medium text-gray-700 mb-1">문법 (Grammar)</label>
                        <input type="number" id="scoreGrammar" min="0" max="100" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="75">
                    </div>
                    <div>
                        <label for="scoreVocab" class="block text-sm font-medium text-gray-700 mb-1">어휘 (Voca)</label>
                        <input type="number" id="scoreVocab" min="0" max="100" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="95">
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-800 border-l-4 border-indigo-500 pl-3">3. 학습 태도 및 역량 (AI 코멘트 생성용)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div class="space-y-1"><label for="select-participation" class="text-sm font-medium text-gray-700">수업 참여도</label><select id="select-participation" class="w-full p-2 border border-gray-300 rounded-lg bg-white shadow-sm"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                    <div class="space-y-1"><label for="select-engagement" class="text-sm font-medium text-gray-700">수업 몰입도</label><select id="select-engagement" class="w-full p-2 border border-gray-300 rounded-lg bg-white shadow-sm"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                    <div class="space-y-1"><label for="select-attitude" class="text-sm font-medium text-gray-700">학습 태도</label><select id="select-attitude" class="w-full p-2 border border-gray-300 rounded-lg bg-white shadow-sm"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                    <div class="space-y-1"><label for="select-diligence" class="text-sm font-medium text-gray-700">성실함 (과제/출결)</label><select id="select-diligence" class="w-full p-2 border border-gray-300 rounded-lg bg-white shadow-sm"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                    <div class="space-y-1"><label for="select-proactiveness" class="text-sm font-medium text-gray-700">주도성 (질문/탐구)</label><select id="select-proactiveness" class="w-full p-2 border border-gray-300 rounded-lg bg-white shadow-sm"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                    <div class="space-y-1"><label for="select-collaboration" class="text-sm font-medium text-gray-700">또래와의 협업 능력</label><select id="select-collaboration" class="w-full p-2 border border-gray-300 rounded-lg bg-white shadow-sm"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                    <div class="space-y-1"><label for="select-concept" class="text-sm font-medium text-gray-700">개념 성취도</label><select id="select-concept" class="w-full p-2 border border-gray-300 rounded-lg bg-white shadow-sm"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                    <div class="space-y-1"><label for="select-problemSolving" class="text-sm font-medium text-gray-700">문제 해결능력</label><select id="select-problemSolving" class="w-full p-2 border border-gray-300 rounded-lg bg-white shadow-sm"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                    <div class="space-y-1"><label for="select-perseverance" class="text-sm font-medium text-gray-700">문제에 대한 끈기</label><select id="select-perseverance" class="w-full p-2 border border-gray-300 rounded-lg bg-white shadow-sm"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                    <div class="space-y-1"><label for="select-criticalThinking" class="text-sm font-medium text-gray-700">비판적 사고</label><select id="select-criticalThinking" class="w-full p-2 border border-gray-300 rounded-lg bg-white shadow-sm"><option value="">선택 안함</option><option value="매우 우수">매우 우수</option><option value="우수">우수</option><option value="보통">보통</option><option value="개선 필요">개선 필요</option></select></div>
                </div>
            </div>

             <div class="space-y-4">
                 <h2 class="text-xl font-semibold text-gray-800 border-l-4 border-indigo-500 pl-3">4. 선생님 추가 전달사항</h2>
                 <textarea id="teacherComment" rows="3" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="AI 생성 코멘트 외에 추가로 전달할 내용이 있다면 여기에 작성해주세요."></textarea>
             </div>

            <div class="pt-6 border-t">
                <button id="generateButton" class="w-full bg-indigo-600 text-white py-4 px-6 rounded-lg text-lg font-semibold shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200 ease-in-out flex items-center justify-center">
                    <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span id="buttonText">리포트 생성하기</span> 
                </button>
            </div>
            
            <div id="errorMessage" class="hidden p-4 bg-red-100 text-red-700 rounded-lg"></div>

        </div>
    </div>

    <div id="report-view" class="hidden">
        <div class="max-w-2xl mx-auto p-6 md:p-8 bg-gray-50 rounded-lg" style="font-family: 'Noto Sans KR', sans-serif;">
            
            <div id="report-buttons" class="mb-6 flex flex-col sm:flex-row gap-2 print:hidden">
                <button id="editButton" class="w-full sm:w-auto flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-700 transition duration-200 text-sm">내용 수정하기</button>
                <button id="printButton" class="w-full sm:w-auto flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition duration-200 text-sm">인쇄하기 (PDF 저장)</button>
            </div>

            <div id="report-header" class="text-center mb-8 pt-4">
                 <svg id="report-header-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-indigo-600 mx-auto mb-2"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" /></svg>
                <h1 id="report-student-name-header" class="text-xl font-semibold text-gray-800"></h1>
                <p id="report-date-header" class="text-sm text-gray-500"></p>
            </div>

            <div class="report-card">
                <h3><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 0 1 9.75 21V8.625Zm5.625-1.5c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v13.5c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V7.125Z" /></svg> 영어 영역별 점수</h3>
                <ul id="report-score-list" class="space-y-1 mb-4"></ul> 
                <div class="mt-4 p-4 bg-gray-50 rounded-lg shadow-inner chart-container-output" style="height: 200px;">
                    <canvas id="scoreChartOutput"></canvas>
                </div>
            </div>

             <div id="teacher-comment-card" class="report-card hidden">
                 <h3><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg> 선생님 추가 전달사항</h3>
                 <p id="report-teacher-comment-display"></p>
             </div>

            <div class="report-card">
                <h3><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193l-3.722.06c-.247.007-.48.118-.634.306l-2.48 2.986a.75.75 0 0 1-1.284 0l-2.48-2.986a1.861 1.861 0 0 0-.634-.306l-3.722-.06A2.25 2.25 0 0 1 3 16.886V12.6c0-.97.616-1.813 1.5-2.097m15.75 0c.884-.284 1.5-1.128 1.5-2.097V6.314a2.25 2.25 0 0 0-2.25-2.25h-9a2.25 2.25 0 0 0-2.25 2.25v.984c0 .97-.616 1.813-1.5 2.097M15.75 0C11.765 0 8.5 3.582 8.5 8c0 .408.024.81.07 1.206l-4.273 4.273a.75.75 0 0 1-1.06-1.06L7.157 8.57A8.001 8.001 0 0 1 15.75 0Z" /></svg> 전하는 말</h3>
                <p id="report-comment-display"></p>
            </div>
            
            <div class="mt-8 pt-4 border-t border-gray-200 text-center text-gray-500 text-xs">
                <p>본 리포트는 인재원 영어에서 학생의 성장을 돕기 위해 정성껏 작성되었습니다.</p>
                <p class="font-semibold mt-1">인재원 영어</p>
            </div>
        </div>
    </div>

    <script>
        let globalApiKey = ""; 
        let outputChartInstance = null;
        let chartDataStore = {};
        
        let isInitialized = false; 
        let isGenerating = false; 
        
        function autoGrowTextarea(element) {
             if (!element) return;
            element.style.height = 'auto';
            element.style.height = (element.scrollHeight) + 'px';
        }

        function getDayOfWeek(dateStr) {
            try {
                const date = new Date(dateStr);
                const days = ['일', '월', '화', '수', '목', '금', '토'];
                const dayIndex = date.getUTCDay(); 
                return days[dayIndex];
            } catch (e) {
                return '';
            }
        }

        function formatFullDateString(dateStr) {
            try {
                const date = new Date(dateStr);
                const year = date.getUTCFullYear();
                const month = date.getUTCMonth() + 1;
                const day = date.getUTCDate();
                const dayOfWeek = getDayOfWeek(dateStr);
                return `${year}년 ${month}월 ${day}일 (${dayOfWeek})`; 
            } catch (e) {
                return dateStr; 
            }
        }

        function initializeApp() {
            if (isInitialized) return; 

            const inputSection = document.getElementById('input-section');
            const reportView = document.getElementById('report-view');
            
            const studentNameInput = document.getElementById('studentName');
            const reportDateInput = document.getElementById('reportDate');
            const parentSelect = document.getElementById('parentSelect'); 
            const teacherCommentInput = document.getElementById('teacherComment'); 
            
            const scoreListeningInput = document.getElementById('scoreListening');
            const scoreReadingInput = document.getElementById('scoreReading');
            const scoreGrammarInput = document.getElementById('scoreGrammar');
            const scoreVocabInput = document.getElementById('scoreVocab');
            
            const generateButton = document.getElementById('generateButton');
            const buttonText = document.getElementById('buttonText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const errorMessage = document.getElementById('errorMessage');
            
            const editButton = document.getElementById('editButton');
            const printButton = document.getElementById('printButton');
            
            const reportStudentNameHeader = document.getElementById('report-student-name-header');
            const reportDateHeader = document.getElementById('report-date-header');
            const reportScoreList = document.getElementById('report-score-list'); 
            const reportTeacherCommentCard = document.getElementById('teacher-comment-card'); 
            const reportTeacherCommentDisplay = document.getElementById('report-teacher-comment-display'); 
            const reportCommentDisplay = document.getElementById('report-comment-display');
            
            const apiKeyInput = document.getElementById('apiKeyInput');
            const saveApiKey = document.getElementById('saveApiKey');
            const apiKeyStatus = document.getElementById('apiKeyStatus');

            const selectElements = document.querySelectorAll('select[id^="select-"]');

            try {
                flatpickr(reportDateInput, {
                    dateFormat: "Y-m-d",
                    defaultDate: "today",
                    locale: "ko"
                });
            } catch (e) {
                console.error("Flatpickr loading failed:", e);
                reportDateInput.placeholder = "YYYY-MM-DD (Date picker failed)";
            }
            
            loadKeyFromStorage(apiKeyInput, apiKeyStatus); 

            if (teacherCommentInput) { 
                 teacherCommentInput.addEventListener('input', () => autoGrowTextarea(teacherCommentInput));
                 autoGrowTextarea(teacherCommentInput); 
            }

            if (generateButton) {
                generateButton.addEventListener('click', () => handleGenerateReport( 
                    apiKeyInput, 
                    studentNameInput, reportDateInput, parentSelect, 
                    scoreListeningInput, scoreReadingInput, scoreGrammarInput, scoreVocabInput,
                    teacherCommentInput, 
                    selectElements,
                    errorMessage,
                    generateButton, buttonText, loadingSpinner
                ));
            } else {
                 console.error("generateButton not found.");
            }
            
            if (editButton) {
                editButton.addEventListener('click', () => showInputView(
                    reportView, inputSection, teacherCommentInput
                ));
            } else {
                 console.error("editButton not found.");
            }

            if (printButton) {
                 printButton.addEventListener('click', () => window.print());
            } else {
                 console.error("printButton not found.");
            }
            
            if (saveApiKey) {
                saveApiKey.addEventListener('click', () => saveKeyToStorage(apiKeyInput, apiKeyStatus));
            } else {
                console.error("saveApiKey button not found.");
            }
            
            if(apiKeyInput) {
                apiKeyInput.addEventListener('input', () => {
                    if(apiKeyStatus) apiKeyStatus.classList.add('hidden'); 
                });
            }
            
            isInitialized = true; 
            console.log("Initialization complete."); 
        }

        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, max: 100, ticks: { font: { family: "'Noto Sans KR', sans-serif", size: 12 } } }, 
                x: { ticks: { font: { family: "'Noto Sans KR', sans-serif", size: 12 } } } 
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    enabled: true,
                    bodyFont: { font: { family: "'Noto Sans KR', sans-serif" } },
                    titleFont: { font: { family: "'Noto Sans KR', sans-serif" } }
                }
            }
        };
        
        function renderOutputChart(scores) { 
            try {
                const ctx = document.getElementById('scoreChartOutput').getContext('2d');
                if (!ctx) { console.error("scoreChartOutput canvas not found."); return; }
                
                if (outputChartInstance) { outputChartInstance.destroy(); }

                const labels = ['듣기', '독해', '문법', '어휘'];
                const data = [
                    scores['듣기'] || 0,
                    scores['독해'] || 0,
                    scores['문법'] || 0,
                    scores['어휘'] || 0
                ];
                const backgroundColors = [
                    'rgba(79, 70, 229, 0.6)', 
                    'rgba(59, 130, 246, 0.6)', 
                    'rgba(16, 185, 129, 0.6)', 
                    'rgba(234, 179, 8, 0.6)'
                ];
                const borderColors = [
                    'rgba(79, 70, 229, 1)', 
                    'rgba(59, 130, 246, 1)', 
                    'rgba(16, 185, 129, 1)', 
                    'rgba(234, 179, 8, 1)'
                ];

                chartDataStore = {
                    labels: labels, 
                    datasets: [{
                        label: '점수', 
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                };
                
                outputChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: chartDataStore, 
                    options: chartOptions
                });
            } catch (e) {
                console.error("Output chart render failed:", e);
            }
        }

        function showInputView(reportView, inputSection, teacherCommentInput) { 
            reportView.classList.add('hidden');
            inputSection.classList.remove('hidden');
            autoGrowTextarea(teacherCommentInput); 
        }

        function showReportView(generatedComment, teacherComment, 
                                studentName, reportDate, 
                                scores) { 
            const reportView = document.getElementById('report-view');
            const inputSection = document.getElementById('input-section');
            const reportStudentNameHeader = document.getElementById('report-student-name-header');
            const reportDateHeader = document.getElementById('report-date-header');
            const reportScoreList = document.getElementById('report-score-list');
            const reportTeacherCommentCard = document.getElementById('teacher-comment-card');
            const reportTeacherCommentDisplay = document.getElementById('report-teacher-comment-display');
            const reportCommentDisplay = document.getElementById('report-comment-display');
            const scoreSection = document.getElementById('report-score-list').closest('.report-card'); 

            reportStudentNameHeader.textContent = studentName;
            reportDateHeader.textContent = formatFullDateString(reportDate); 
            
            reportScoreList.innerHTML = ''; 
            const scoreLabels = {'듣기': '듣기 (L/C)', '독해': '독해 (R/C)', '문법': '문법 (Grammar)', '어휘': '어휘 (Voca)'};
            let hasScores = false;
            Object.keys(scores).forEach(key => {
                 if (scores[key] !== null && scores[key] !== undefined && scores[key] !== '') {
                     const listItem = document.createElement('li');
                     listItem.textContent = `${scoreLabels[key] || key}: ${scores[key]}점`;
                     reportScoreList.appendChild(listItem);
                     hasScores = true;
                 }
            });

            if (hasScores) {
                 scoreSection.style.display = 'block'; 
                 renderOutputChart(scores); 
            } else {
                 scoreSection.style.display = 'none'; 
                 if (outputChartInstance) {
                     outputChartInstance.destroy(); 
                     outputChartInstance = null; 
                 }
            }
            
            if (teacherComment && teacherComment.trim() !== '') {
                 reportTeacherCommentDisplay.textContent = teacherComment;
                 reportTeacherCommentCard.classList.remove('hidden');
            } else {
                 reportTeacherCommentDisplay.textContent = '';
                 reportTeacherCommentCard.classList.add('hidden');
            }

            reportCommentDisplay.textContent = generatedComment || "(코멘트 생성 실패)"; 
            
            inputSection.classList.add('hidden');
            reportView.classList.remove('hidden');
            window.scrollTo(0, 0); 
        }

        async function handleGenerateReport( 
            apiKeyInput, studentNameInput, reportDateInput, parentSelect, 
            scoreListeningInput, scoreReadingInput, scoreGrammarInput, scoreVocabInput,
            teacherCommentInput,
            selectElements,
            errorMessage,
            generateButton, buttonText, loadingSpinner
        ) {
            console.log("handleGenerateReport called"); 
            if (isGenerating) {
                 console.log("Generation already in progress.");
                 return; 
            }

            if (!globalApiKey) {
                showError("API 키를 먼저 '0. API 키 설정'에서 입력하고 저장해 주세요.", errorMessage);
                if(apiKeyInput) apiKeyInput.focus();
                return;
            }

            const studentName = studentNameInput.value.trim();
            const reportDate = reportDateInput.value;
            const parentName = parentSelect.value; 
            const teacherComment = teacherCommentInput.value.trim();

            const scores = {
                 '듣기': scoreListeningInput.value.trim(),
                 '독해': scoreReadingInput.value.trim(),
                 '문법': scoreGrammarInput.value.trim(),
                 '어휘': scoreVocabInput.value.trim()
            };

            studentNameInput.classList.remove('error-highlight');
            reportDateInput.classList.remove('error-highlight');
            [scoreListeningInput, scoreReadingInput, scoreGrammarInput, scoreVocabInput].forEach(input => {
                 input.classList.remove('error-highlight');
            });


            if (!studentName) {
                showError("학생 이름을 입력해주세요.", errorMessage);
                studentNameInput.focus();
                studentNameInput.classList.add('error-highlight');
                return;
            }
            if (!reportDate) {
                showError("리포트 날짜를 입력해주세요.", errorMessage);
                reportDateInput.focus();
                reportDateInput.classList.add('error-highlight');
                return;
            }

            let hasInvalidScore = false;
            Object.keys(scores).forEach(key => {
                 const score = scores[key];
                 const inputElement = document.getElementById(`score${key.charAt(0).toUpperCase() + key.slice(1).toLowerCase().replace('문법','Grammar').replace('어휘','Vocab').replace('듣기','Listening').replace('독해','Reading')}`); // Get the corresponding input element
                 if (score !== '' && (isNaN(parseInt(score)) || parseInt(score) < 0 || parseInt(score) > 100)) {
                     showError(`${key} 점수는 0과 100 사이의 숫자여야 합니다.`, errorMessage);
                     if (inputElement) inputElement.focus();
                     if (inputElement) inputElement.classList.add('error-highlight');
                     hasInvalidScore = true;
                 } else if (inputElement) {
                      inputElement.classList.remove('error-highlight');
                 }
            });
             if (hasInvalidScore) return;

             // Convert empty strings to null for processing, keep valid numbers
             const processedScores = {};
             let hasAnyScore = false;
             Object.keys(scores).forEach(key => {
                 const score = scores[key];
                 if (score === '') {
                     processedScores[key] = null;
                 } else {
                     processedScores[key] = parseInt(score);
                     hasAnyScore = true; // Mark that at least one score exists
                 }
             });


            setLoading(true, generateButton, buttonText, loadingSpinner, errorMessage);
            isGenerating = true; 

            let characteristics = []; 
            selectElements.forEach(select => {
                if (select.value) {
                    const label = select.previousElementSibling.textContent;
                    characteristics.push({
                        item: label,
                        level: select.value
                    });
                }
            });

            const systemPrompt = `당신은 '인재원 영어' 학원의 전문적이고 학생에게 애정이 넘치는, 다정다감한 선생님입니다. 학부모님께 학생의 영어 학습 리포트를 전달하는 역할을 맡고 있습니다. 제공되는 학생의 영어 영역별 점수 (듣기, 독해, 문법, 어휘), 학습 태도, 그리고 선생님 추가 코멘트 데이터를 바탕으로, **[전하는 말]** 섹션에 들어갈 자연스러운 AI 코멘트만 한국어로 작성해 주세요. **매우 중요 (인간적인 톤 & 분량 & 내용):** - **사근사근한 말투:** 사무적이고 딱딱한 보고서 톤은 절대 금지합니다. 따뜻하고 사근사근한 말투를 사용해 주세요. "~했어요", "~하고 있어요" 같은 부드러운 종결어미를 선호합니다. - **친근한 호칭:** 학생 이름이 주어지면(예: 김소선), '소선 학생' 대신 "소선이가", "소선이의"처럼 친근하게 불러주세요. - **간결한 분량:** AI 코멘트는 **5~7 문장 내외로 간결하게** 핵심만 요약해 주세요. - **리포트 형식 준수:** 생성 내용은 오직 **[전하는 말]** 섹션의 AI 코멘트 본문입니다. 제목, 날짜, 점수 목록 등 다른 섹션 내용은 포함하지 마세요. 선생님 추가 코멘트도 AI 코멘트에 포함하지 마세요. - **학부모 호칭 사용 금지:** AI 코멘트 본문에는 부모님, 어머님 등의 호칭을 사용하지 마세요. - **기간 표현 금지:** 이 리포트는 **'오늘 하루'** 또는 특정 테스트에 대한 내용입니다. **'이번 주', '이번 달' 등 더 긴 기간 표현은 사용하지 마세요.** - **점수 분석:** 4개 영역(듣기, 독해, 문법, 어휘) 점수를 종합적으로 고려하여 강점과 보완점을 분석해주세요. 점수가 낮은 영역이 있다면 부드럽게 언급하고 격려해주세요. - **문단 나누기:** 내용상 구분이 필요하면 줄바꿈 문자(\`\\n\\n\`)를 사용하여 문단을 나누어 가독성을 높여주세요. **[전하는 말] 코멘트의 자연스러운 흐름:** * (칭찬) **오늘** 학생의 긍정적인 모습 (학습 태도, 특정 영역 점수 향상 등) 칭찬. * (성장 영역) **오늘** 보완이 필요한 부분 (학습 태도, 점수가 낮은 영역 등) 언급. * (지도 계획) 성장 영역을 돕기 위해 **앞으로** 어떻게 지도할지 간략히 제시. * (마무리) 학생 격려 및 학부모님께 감사 인사.`;

            let userQuery = `다음은 ${studentName} 학생의 오늘(${reportDate}) 영어 학습 데이터입니다.\n\n`;
            userQuery += `영어 영역별 점수:\n`;
            if (hasAnyScore) {
                Object.keys(processedScores).forEach(key => {
                     if (processedScores[key] !== null) {
                         userQuery += `- ${key}: ${processedScores[key]}점\n`;
                     }
                });
            } else {
                userQuery += `- 오늘 실시한 테스트가 없습니다.\n`;
            }
            userQuery += `\n`;
            
            userQuery += `학습 태도 및 역량:\n${JSON.stringify(characteristics)}\n\n`;
            if (teacherComment) {
                userQuery += `선생님 추가 전달사항 (참고용):\n${teacherComment}\n\n`;
            }
            userQuery += "이 데이터를 바탕으로, 위 시스템 프롬프트의 모든 규칙을 준수하여 **[전하는 말]** 섹션에 들어갈 **AI 코멘트 본문만** 작성해 주세요.";


            try {
                const generatedComment = await callGeminiAPI(systemPrompt, userQuery); 
                showReportView(
                    generatedComment, teacherComment, 
                    studentName, reportDate, 
                    processedScores 
                );
            } catch (error) {
                console.error("AI Generation Failed:", error);
                showError("리포트 생성에 실패했습니다. " + error.message, errorMessage);
            } finally {
                setLoading(false, generateButton, buttonText, loadingSpinner, errorMessage);
                isGenerating = false; 
            }
        }

        async function callGeminiAPI(systemPrompt, userQuery) {
             if (!globalApiKey) {
                 throw new Error("API 키가 설정되지 않았습니다.");
             }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${globalApiKey}`;
            
            const payload = {
                contents: [{
                    parts: [{ text: userQuery }]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    temperature: 0.8, 
                    topP: 0.9,
                    topK: 40
                }
            };

            let response;
            let retries = 3;
            let delay = 2000; 

            for (let i = 0; i < retries; i++) {
                try {
                    console.log(`Attempt ${i + 1} to call Gemini API`); 
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    console.log(`API Response Status: ${response.status}`); 

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                            return result.candidates[0].content.parts[0].text.trim();
                        } else if (result.candidates && result.candidates[0].finishReason === "SAFETY") {
                             throw new Error("콘텐츠 생성 중 안전상의 이유로 중단되었습니다. 입력 내용을 확인해주세요.");
                        } else {
                            console.error("Unexpected API response structure:", result);
                            throw new Error("AI로부터 유효한 응답을 받지 못했습니다. (응답 형식 오류)");
                        }
                    } else {
                        if (response.status === 429 || response.status >= 500) { 
                            if (i === retries - 1) throw new Error(`서버 오류 또는 요청 한도 초과 (Status: ${response.status})`);
                            console.log(`Retrying after ${delay}ms due to status ${response.status}`); 
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; 
                        } else {
                            const errorBody = await response.json().catch(() => ({ error: { message: response.statusText } })); 
                            const errorMessage = errorBody.error?.message || response.statusText;
                            if (response.status === 401 || response.status === 403) {
                                throw new Error(`API 키가 유효하지 않습니다. (오류: ${errorMessage})`);
                            }
                            if (errorMessage.includes("API has not been used") || errorMessage.includes("disabled")) {
                                throw new Error(`API 사용 설정이 필요합니다. Google Cloud에서 'Generative Language API' 또는 'Vertex AI API'를 활성화(Enable)해주세요. (오류: ${errorMessage})`);
                            }
                             if (response.status === 400) {
                                 console.error("API Request Payload:", payload); 
                                 throw new Error(`잘못된 요청입니다 (400 Bad Request). API 요청 내용을 확인해주세요. 오류: ${errorMessage}`);
                             }
                            throw new Error(`API 오류: ${errorMessage}`);
                        }
                    }
                } catch (networkError) {
                    if (i === retries - 1) throw new Error(`네트워크 오류: ${networkError.message}`);
                    console.log(`Retrying after ${delay}ms due to network error: ${networkError.message}`); 
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            throw new Error("Failed to generate report after multiple retries.");
        }


        function setLoading(isLoading, generateButton, buttonText, loadingSpinner, errorMessage) {
            if (isLoading) {
                generateButton.disabled = true;
                buttonText.textContent = "AI가 생성 중입니다..."; 
                loadingSpinner.classList.remove('hidden');
                errorMessage.classList.add('hidden');
            } else {
                generateButton.disabled = false;
                buttonText.textContent = "리포트 생성하기"; 
                loadingSpinner.classList.add('hidden');
            }
        }

        function showError(message, errorMessage) {
             if (!errorMessage) return; 
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }
        
        function saveKeyToStorage(apiKeyInput, apiKeyStatus) {
            try {
                const key = apiKeyInput.value.trim();
                if (key && key.startsWith('AIza')) { 
                    localStorage.setItem('injaewonApiKey_english_v1', key); // 키 이름 변경
                    globalApiKey = key;
                    apiKeyStatus.textContent = 'API 키가 브라우저에 안전하게 저장되었습니다.';
                    apiKeyStatus.classList.remove('hidden', 'text-red-600');
                    apiKeyStatus.classList.add('text-green-600');
                    apiKeyInput.value = '**********' + key.slice(-4); 
                } else {
                    apiKeyStatus.textContent = "유효하지 않은 API 키 형식입니다. 'AIza...'로 시작해야 합니다.";
                    apiKeyStatus.classList.remove('hidden', 'text-green-600');
                    apiKeyStatus.classList.add('text-red-600');
                }
            } catch (e) {
                console.error("Failed to save key (localStorage error):", e);
                apiKeyStatus.textContent = "키 저장에 실패했습니다. 브라우저의 쿠키/사이트 데이터 저장 설정을 확인해주세요.";
                apiKeyStatus.classList.remove('hidden', 'text-green-600');
                apiKeyStatus.classList.add('text-red-600');
            }
        }

        function loadKeyFromStorage(apiKeyInput, apiKeyStatus) {
            try {
                const savedKey = localStorage.getItem('injaewonApiKey_english_v1'); // 키 이름 변경
                if (savedKey) {
                    globalApiKey = savedKey;
                    apiKeyInput.value = '**********' + savedKey.slice(-4); 
                    apiKeyStatus.textContent = '저장된 API 키를 불러왔습니다. (새 키 입력 시 덮어씁니다)';
                    apiKeyStatus.classList.remove('hidden', 'text-red-600');
                    apiKeyStatus.classList.add('text-green-600');
                } else {
                    apiKeyStatus.textContent = "AI 자동 생성을 사용하려면 API 키를 입력 후 '키 저장하기'를 눌러주세요."; 
                    apiKeyStatus.classList.remove('hidden', 'text-green-600');
                    apiKeyStatus.classList.add('text-red-600');
                }
            } catch (e) {
                console.error("Failed to load key (localStorage error):", e);
                apiKeyStatus.textContent = "키 로드에 실패했습니다. 브라우저의 쿠키/사이트 데이터 저장 설정을 확인해주세요.";
                apiKeyStatus.classList.remove('hidden', 'text-green-600');
                apiKeyStatus.classList.add('text-red-600');
            }
        }
        
        initializeApp();
    </script>
</body>
</html>
